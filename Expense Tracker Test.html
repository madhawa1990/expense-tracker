<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

<title>Expense Tracker</title>

<style>
body{
  font-family: system-ui;
  padding:10px;
  max-width:400px;
  margin:auto;
  background-color: #f8f9fa;
}
input, select, button{
  width:100%;
  padding:12px;
  margin:8px 0;
  font-size:16px;
}
button{
  background:#000;
  color:white;
  border:none;
}
label {
    color: #7a7978;
}

.totalSummaryDiv {
    font-size: 20px;
    font-weight: 700;
    font-family: calibri;
}

.smallBtn{
  font-size: 15px;
  padding-top: 3px; 
  padding-bottom: 3px;
  height: 25px;
}
</style>
</head>

<body>

<!-- <h2>Add Expense</h2> -->

<!-- <input id="mdate" placeholder="Date" type="date">
<select id="category"></select>
<input id="desc" placeholder="Description">
<input id="amount" type="number" placeholder="Amount">
<button onclick="save()">Save Expense</button> -->

<div class="container mt-5">
  <h2 class="mb-4 text-center">Add Expense</h2>

<div class="row mb-0">
  <div class="col-6">
      <!-- <div class="btn-group btn-group-lg" role="group" aria-label="Large button group"> -->
        <button type="button" class="btn btn-outline-primary w-100"
          style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;" id="btnSummary" onclick="switchDives('summary')">
          Summary
        </button>
      <!-- </div> -->
  </div>
  <div class="col-6">
    <button type="button" class="btn btn-outline-primary w-100" id="btnAddNew" onclick="switchDives('addNew')"
      style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
      Add New
    </button>
  </div>
</div>

  
  <div class="row mb-2" id="totSummaryMain">
    <div class="col">
      <div class="card" style="">
        <ul class="list-group list-group-flush" id="">
          <li class="list-group-item" >
            <span style="font-size: 20px;font-weight: 700;font-family: calibri;" class="d-block mb-0">Monthly Snapshot</span>
            <span class="d-block mb-3 mt-3 text-center" id="totSummaryLoading">
              <div class="spinner-border text-info text-center" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </span>
            <span style ="font-size: 50px;font-weight: 600;font-family: calibri;" class="d-block" id="totSummary"></span>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="row" id="summaryMain">
    <div class="col">
      <div class="card" style="">
        <span class="d-block mb-3 mt-3 text-center" id="SummaryLoading">
          <div class="spinner-border text-info text-center" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </span>
        <ul class="list-group list-group-flush" id="summaryDiv">
            
        </ul>
        <div class="card-footer" id="card-footer-total">
        </div>
      </div>
    </div>
  </div>


  <div class="row" id="addMain">
    <div class="col">
      <form id="expenseForm" class="needs-validation" novalidate>
          <!-- Date -->
          <div class="mb-3">
            <label for="expenseDate" class="form-label mb-0">Date</label>
            <input type="date" class="form-control mt-0 mb-0 form-control-lg" id="mdate" name="mdate" required>
            <div class="invalid-feedback">Please select a date.</div>
          </div>

          <!-- Category -->
          <div class="mb-3">
            <label for="category" class="form-label mb-0">Category</label>
            <select class="form-control mt-0 mb-0 form-control-lg" id="category" name="category" required>
              <option value="">Select category</option>
            </select>
            <div class="invalid-feedback">Please select a category.</div>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label for="description" class="form-label mb-0">Description</label>
            <input type="text" class="form-control mt-0 mb-0 form-control-lg" id="desc" name="desc" placeholder="Enter description" required>
            <div class="invalid-feedback">Please enter a description.</div>
          </div>

          <!-- Amount -->
          <div class="mb-3">
            <label for="amount" class="form-label mb-0">Amount</label>
            <input type="number" class="form-control mt-0 mb-0 form-control-lg" id="amount" name="amount" placeholder="0.00" min="0" step="0.01" required>
            <div class="invalid-feedback">Please enter a valid amount.</div>
          </div>

          <!-- Save Button -->
          <button type="submit" class="btn btn-primary form-control-lg" id="saveBtn">
            <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Save Expense
          </button>
        </form>
    </div>
  </div>
</div>


<script>

const URL = "https://script.google.com/macros/s/AKfycbz-BNJS5HcpvyDW8T_1dohHYFg1hu0HJGECEOxDoI2GfwAHOxPa-HZ3RDBIMHiT-GoFqA/exec";




// Load categories
async function loadCategories(){
  const res = await fetch(URL+"?method=categories");
  const data = await res.json();
  const select = document.getElementById("category");

  data.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c;
    opt.text = c;
    select.appendChild(opt);
  });
}

function showLoading(ele) {
    document.getElementById(ele).classList.remove("d-none");
}

function hideLoading(ele) {
    document.getElementById(ele).classList.add("d-none");
}

document.getElementById("btnSummary").click();
function switchDives(btn){
  const summaryMain = document.getElementById("summaryMain");
  const totSummaryMain = document.getElementById("totSummaryMain");
  const addMain = document.getElementById("addMain");
  if(btn=="summary"){
    summaryMain.classList.remove('d-none');
    totSummaryMain.classList.remove('d-none');
    addMain.classList.add("d-none");
    loadSummary();
  }else{
    summaryMain.classList.add('d-none');
    totSummaryMain.classList.add('d-none');
    addMain.classList.remove("d-none");
  }
}

const form = document.getElementById('expenseForm');
const spinner = document.getElementById('loadingSpinner');

 form.addEventListener('submit', async function(event) {
  event.preventDefault(); // Prevent page refresh
  event.stopPropagation();

  const category = document.getElementById("category").value;
  const description = document.getElementById("desc").value;
  const amount = document.getElementById("amount").value;
  const mdate = document.getElementById("mdate").value;

  if (!form.checkValidity()) {
    form.classList.add('was-validated');
    return;
  }

  spinner.classList.remove('d-none');
  saveBtn.setAttribute('disabled', true);
  //messageDiv.innerHTML = '';

    await fetch(URL,{
    method:"POST",
    body: JSON.stringify({
      category,
      description,
      amount
    })
  });
    desc.value="";
    amount.value="";
    spinner.classList.add('d-none');
    saveBtn.removeAttribute('disabled');
    form.reset();
    document.getElementById('mdate').value = today; // Reset date to today
    form.classList.remove('was-validated');

});

const today = new Date().toISOString().split('T')[0];
document.getElementById('mdate').value = today;

loadCategories();
loadSummary();

async function loadSummary() {
  const month = "2026-Feb"; // or dynamic

  showLoading("totSummaryLoading");
  showLoading("SummaryLoading");

  const summaryDiv  = document.getElementById("summaryDiv");
  const totalDiv    = document.getElementById("card-footer-total");
  const totSummary  = document.getElementById("totSummary");
  summaryDiv.innerHTML = "";
  totSummary.innerHTML = "";
  totalDiv.innerHTML   = ""; 
  
  const res = await fetch(URL+"?method=summary"+"&month="+month);
  const data = await res.json();

  summaryDiv.innerHTML = "";
  totSummary.innerHTML = "";
  totalDiv.innerHTML   = ""; 

  let total = 0;

  for (const cat in data) {
    if(cat!=""){
    total += data[cat];
    summaryDiv.innerHTML += `
    <li class="list-group-item  d-flex justify-content-between"><span class="">${cat}</span> <span class="">€ ${data[cat].toFixed(2)}</span></li>
    `;
    }
  }

  hideLoading("totSummaryLoading");
  hideLoading("SummaryLoading");
  totSummary.innerHTML = `€ ${total.toFixed(2)}`;
  totalDiv.innerHTML += `
  <li class="list-group-item  d-flex justify-content-between fw-bold mt-2"><span class="">Total</span> <span class="">€ ${total.toFixed(2)}</span></li>
    `;
}

</script>
</body>
</html>